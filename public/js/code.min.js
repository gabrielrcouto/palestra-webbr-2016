var $ = jQuery;

var Modules = {};
var Pages = {};
Modules.chat = {
	start: function () {
		Reveal.addEventListener('slidechanged', function( event ) {
			Modules.chat.checkCurrentSlide(event.currentSlide);
		});

		$('div.chat .button').on('tap click', function(event) {
			event.preventDefault();
			Modules.chat.sendMessage();
		});

		$('div.chat input').on('keypress', function(e) {
		    if(e.which == 13) {
		        Modules.chat.sendMessage();
		    }
		});

		ratchet.on(1, this.callback);

		Modules.chat.checkCurrentSlide(Reveal.getCurrentSlide());
	},

	callback: function(data) {
		if (data.type == 'chat') {
			$('div.chat .messages').prepend('<p><strong>' + data.nickname + '</strong>: ' + data.message + '</p>');
		}
	},

	checkCurrentSlide: function(currentSlide) {
		if ($(currentSlide).hasClass('chat-slide') && $('body').attr('data-mode') != 'presenter') {
			if (!Modules.chat.initialized) {
				Modules.chat.init();
				$('div.chat').show();
			}
		} else {
			if (Modules.chat.initialized) {
				Modules.chat.initialized = false;
				$('div.chat').hide();
			}
		}
	},

	initialized: false,

	init: function() {
		Modules.chat.initialized = true;
	},

	sendMessage: function() {
		var message = $('div.chat input[type="text"]').val();

		if (message != '') {
			ratchet.emit('chat', {message: message});
			$('div.chat .messages').prepend('<p class="me"><strong>[EU]</strong>: ' + message + '</p>');
			$('div.chat input[type="text"]').val('');
			Modules.sound.horn();
		}
	}
}
Modules.counter = {
	start: function () {
		ratchet.on(1, this.callback);
	},

	callback: function(data) {
		if (data.type == 'counter') {
			$('.users-counter').html(data.number);
		}
	},
}
Modules.horn = {
	start: function() {
		//Listener do botão
		$('.horn.button').on('tap click', function(event) {
			event.preventDefault();

			Modules.sound.horn();

			ratchet.emit('horn', {});
			Modules.horn.countMe++;
			Modules.horn.renderCounter();
		});

		$('.horn.button span').on('tap click', function(event) {
			event.preventDefault();
		});

		//Listener do socket
		ratchet.on(1, this.callback);
	},

	countMe: 0,

	countOthers: 0,

	callback: function(data) {
		if (data.type == 'horn') {
			Modules.sound.horn();
			Modules.horn.countOthers++;
			Modules.horn.renderCounter();
		}
	},

	renderCounter: function() {
		$('.horn.counter').html(Modules.horn.countMe + '/' + Modules.horn.countOthers);
	}
}
Modules.jequiti = {
	start: function () {
		Reveal.addEventListener('slidechanged', function( event ) {
			Modules.jequiti.checkCurrentSlide(event.currentSlide);
		});

		Modules.jequiti.checkCurrentSlide(Reveal.getCurrentSlide());
	},

	checkCurrentSlide: function(currentSlide) {
		if ($(currentSlide).hasClass('jequiti')) {
			setTimeout(function() {
				$('div.jequiti-background').show();

				setTimeout(function() {
					$('div.jequiti-background').hide();
				}, 500);	
			}, 2000);
		}
	}
}
Modules.poll = {
	start: function() {
		//Listener dos botões
		$('.poll .button-level').on('tap click', function(event) {
			event.preventDefault();

			var poll = $(this).closest('.poll');

			if (!$(poll).hasClass('votado')) {
				ratchet.emit('poll', {number: $(poll).attr('data-number'), value: $(this).attr('data-value')});
				$(poll).addClass('votado');
				Modules.sound.horn();
			}
		});

		$('.poll .button-level span').on('tap click', function(event) {
			event.preventDefault();
		});

		//Listener do socket
		ratchet.on(1, this.callback);
	},

	callback: function(data) {
		if (data.type == 'poll-result') {
			var poll = $('.poll[data-number="' + data.number + '"]');

			$.each(data.votes, function(index, quantity) {
				poll.find('.button-level[data-value="' + index + '"]').find('span b').html(quantity);
			});

			$.each(data.percentages, function(index, quantity) {
				poll.find('.button-level[data-value="' + index + '"]').find('.level').height(quantity + '%');
			});
		}
	},
}
Modules.sound = {
	start: function() {
		 createjs.Sound.alternateExtensions = ['mp3'];
		 createjs.Sound.registerSound('sounds/horn.ogg', 'horn');
		 createjs.Sound.registerSound('sounds/comecar.ogg', 'comecar');
		 createjs.Sound.registerSound('sounds/qualresposta.ogg', 'qualresposta');
		 createjs.Sound.registerSound('sounds/suspense02.ogg', 'suspense02');
		 createjs.Sound.registerSound('sounds/tchau.ogg', 'tchau');

		 Reveal.addEventListener('slidechanged', function( event ) {
			Modules.sound.checkCurrentSlide(event.currentSlide);
		});

		Modules.sound.checkCurrentSlide(Reveal.getCurrentSlide());
	},

	horn: function() {
		var instance = createjs.Sound.play('horn');
	    instance.volume = 0.5;
	},

	checkCurrentSlide: function(currentSlide) {
		if ($(currentSlide).hasClass('sound-comecar')) {
			var instance = createjs.Sound.play('comecar');
	    	instance.volume = 0.5;
		}  else if ($(currentSlide).hasClass('sound-qualresposta')) {
			var instance = createjs.Sound.play('qualresposta');
	    	instance.volume = 0.5;
		}  else if ($(currentSlide).hasClass('sound-suspense02')) {
			var instance = createjs.Sound.play('suspense02');
	    	instance.volume = 0.5;
		}  else if ($(currentSlide).hasClass('sound-tchau')) {
			var instance = createjs.Sound.play('tchau');
	    	instance.volume = 0.5;
		}
	}
}
//$(document).ready(function() {
	//Use funções de start para cada função do site

	//Inicia todos os módulos
	for(var propertyName in Modules) {
	   Modules[propertyName].start();
	}

	//Inicia todas as páginas
	for(var propertyName in Pages) {
	   Pages[propertyName].start();
	}
//});